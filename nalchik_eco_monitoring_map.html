<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ - –ù–∞–ª—å—á–∏–∫, –í–æ–ª—å–Ω—ã–π –∞—É–ª</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #2c3e50;
            overflow: hidden;
        }
        
        #map {
            height: 100vh;
            width: 100%;
        }
        
        /* ========================
           ECO MONITORING PANEL
        ======================== */
        .eco-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 0;
            border-radius: 12px;
            box-shadow: 0 6px 25px rgba(0,0,0,0.4);
            z-index: 1000;
            max-width: 380px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .eco-panel.hidden {
            transform: translateX(450px);
            opacity: 0;
            pointer-events: none;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 18px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-header h2 {
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
        }
        
        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .panel-body {
            padding: 20px;
        }
        
        .instructions {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #27ae60;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .instructions strong {
            display: block;
            margin-bottom: 8px;
            color: #27ae60;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-top: 3px solid #27ae60;
        }
        
        .stat-card .label {
            font-size: 12px;
            color: #7f8c8d;
            text-transform: uppercase;
            margin-bottom: 6px;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .route-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .route-info.active {
            display: block;
        }
        
        .route-info h3 {
            font-size: 14px;
            color: #27ae60;
            margin-bottom: 10px;
        }
        
        .route-detail {
            display: flex;
            justify-content: space-between;
            margin: 6px 0;
            font-size: 13px;
        }
        
        .route-detail .label {
            color: #555;
        }
        
        .route-detail .value {
            font-weight: bold;
            color: #27ae60;
        }
        
        #status {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        #status.waiting {
            background: #fff3cd;
            color: #856404;
            border-left-color: #ffc107;
        }
        
        #status.active {
            background: #cce5ff;
            color: #004085;
            border-left-color: #007bff;
        }
        
        /* ========================
           TOGGLE BUTTON
        ======================== */
        .toggle-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
            z-index: 999;
            display: none;
            transition: all 0.3s;
        }
        
        .toggle-btn.visible {
            display: block;
        }
        
        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(39, 174, 96, 0.5);
        }
        
        /* ========================
           LEGEND
        ======================== */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 18px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 13px;
            max-width: 300px;
        }
        
        .legend-title {
            font-weight: bold;
            margin-bottom: 12px;
            color: #2c3e50;
            font-size: 15px;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 8px 0;
            padding: 4px;
        }
        
        .legend-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            margin-right: 10px;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            flex-shrink: 0;
        }
        
        .legend-line {
            width: 30px;
            height: 4px;
            margin-right: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        
        /* ========================
           LOADING OVERLAY
        ======================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
        }
        
        .loading-overlay.hidden {
            display: none;
        }
        
        .spinner {
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .loading-subtext {
            font-size: 15px;
            opacity: 0.9;
        }
        
        /* ========================
           CUSTOM MARKERS
        ======================== */
        .custom-marker {
            background: transparent;
            border: none;
        }
        
        .start-point-marker {
            background: transparent;
            border: none;
        }
        
        /* ========================
           POPUP STYLING
        ======================== */
        .leaflet-popup-content-wrapper {
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.6;
            min-width: 260px;
            margin: 16px;
        }
        
        .popup-header {
            font-size: 17px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .popup-section {
            margin: 10px 0;
        }
        
        .popup-label {
            font-weight: 600;
            color: #7f8c8d;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .popup-description {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #e74c3c;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .severity-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .severity-critical { background: #e74c3c; color: white; }
        .severity-urgent { background: #e67e22; color: white; }
        .severity-medium { background: #f39c12; color: white; }
        .severity-collection { background: #27ae60; color: white; }
        
        /* Hide routing instructions panel */
        .leaflet-routing-container {
            display: none;
        }
        
        /* District label */
        .district-label {
            background: rgba(52, 152, 219, 0.95);
            color: white;
            padding: 10px 18px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
            border: 3px solid white;
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–π –∫–∞—Ä—Ç—ã...</div>
        <div class="loading-subtext" id="loadingSubtext">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã</div>
    </div>
    
    <!-- Toggle button (shown when panel is closed) -->
    <button class="toggle-btn" id="toggleBtn">
        üåç –û—Ç–∫—Ä—ã—Ç—å –ø–∞–Ω–µ–ª—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
    </button>
    
    <!-- Eco monitoring panel -->
    <div class="eco-panel" id="ecoPanel">
        <div class="panel-header">
            <h2>üåç –≠–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h2>
            <button class="close-btn" id="closeBtn">√ó</button>
        </div>
        
        <div class="panel-body">
            <div class="instructions">
                <strong>–ö–∞–∫ –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç:</strong>
                1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞<br>
                2. –ó–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä –∑–∞–≥—Ä—è–∑–Ω—ë–Ω–Ω–æ–≥–æ –º–µ—Å—Ç–∞<br>
                3. –ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –¥–æ—Ä–æ–≥–∞–º
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="label">–í—Å–µ–≥–æ —Ç–æ—á–µ–∫</div>
                    <div class="value" id="totalPoints">11</div>
                </div>
                <div class="stat-card">
                    <div class="label">–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö</div>
                    <div class="value" id="criticalPoints" style="color: #e74c3c;">0</div>
                </div>
            </div>
            
            <div class="route-info" id="routeInfo">
                <h3>üìç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ</h3>
                <div class="route-detail">
                    <span class="label">–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</span>
                    <span class="value" id="routeDistance">‚Äî</span>
                </div>
                <div class="route-detail">
                    <span class="label">–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</span>
                    <span class="value" id="routeTime">‚Äî</span>
                </div>
                <div class="route-detail">
                    <span class="label">–¶–µ–ª—å:</span>
                    <span class="value" id="routeTarget">‚Äî</span>
                </div>
            </div>
            
            <div id="status">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>
        </div>
    </div>
    
    <!-- Legend -->
    <div class="legend">
        <div class="legend-title">üìä –õ–µ–≥–µ–Ω–¥–∞</div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #e74c3c;"></div>
            <span>–ö—Ä–∏—Ç–∏—á–Ω–æ - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #e67e22;"></div>
            <span>–°—Ä–æ—á–Ω–æ - —Ç—Ä–µ–±—É–µ—Ç —É–±–æ—Ä–∫–∏</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #f39c12;"></div>
            <span>–°—Ä–µ–¥–Ω–µ - –ø–ª–∞–Ω–æ–≤–∞—è —É–±–æ—Ä–∫–∞</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #27ae60;"></div>
            <span>–ü—É–Ω–∫—Ç —Å–±–æ—Ä–∞ / —Å–ø–µ—Ü—Å–±–æ—Ä</span>
        </div>
        <div class="legend-item">
            <div class="legend-icon" style="background: #3498db; font-size: 16px; display: flex; align-items: center; justify-content: center; color: white;">üìç</div>
            <span>–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</span>
        </div>
        <div class="legend-item">
            <div class="legend-line" style="background: #9b59b6;"></div>
            <span>–ú–∞—Ä—à—Ä—É—Ç –ø–æ –¥–æ—Ä–æ–≥–∞–º</span>
        </div>
    </div>
    
    <!-- Map container -->
    <div id="map"></div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script>
        // ===============================================
        // CONFIGURATION
        // ===============================================
        
        const CONFIG = {
            mapCenter: [43.4786, 43.6275],
            defaultZoom: 13,
            minZoom: 11,
            maxZoom: 18,
            routingService: 'https://router.project-osrm.org/route/v1',
            geocodingService: 'https://nominatim.openstreetmap.org/search',
            geocodingDelay: 1100,
        };
        
        // Locations
        const LOCATIONS = [
            { id: 1, lat: 43.4752, lon: 43.6210, label: "–¢–æ—á–∫–∞ 1" },
            { id: 2, address: "—É–ª. –ö–∞–ª–º—ã–∫–æ–≤–∞, 235, –ù–∞–ª—å—á–∏–∫, –†–æ—Å—Å–∏—è", label: "—É–ª. –ö–∞–ª–º—ã–∫–æ–≤–∞, 235" },
            { id: 3, lat: 43.4658, lon: 43.6482, label: "–¢–æ—á–∫–∞ 3" },
            { id: 4, address: "—É–ª. –†—É—Å—Ç–∞–≤–µ–ª–∏, 40, –ù–∞–ª—å—á–∏–∫, –†–æ—Å—Å–∏—è", label: "—É–ª. –†—É—Å—Ç–∞–≤–µ–ª–∏, 40" },
            { id: 5, address: "—É–ª. 2-–π –¢–∞–º–∞–Ω—Å–∫–æ–π –î–∏–≤–∏–∑–∏–∏, 45, –ù–∞–ª—å—á–∏–∫, –†–æ—Å—Å–∏—è", label: "—É–ª. 2-–π –¢–∞–º–∞–Ω—Å–∫–æ–π –î–∏–≤–∏–∑–∏–∏, 45" },
            { id: 6, lat: 43.4712, lon: 43.6185, label: "–¢–æ—á–∫–∞ 6" },
            { id: 7, address: "—É–ª. –ò—Å–∞–µ–≤–∞, 101, –ù–∞–ª—å—á–∏–∫, –†–æ—Å—Å–∏—è", label: "—É–ª. –ò—Å–∞–µ–≤–∞, 101" },
            { id: 8, lat: 43.4615, lon: 43.6450, label: "–¢–æ—á–∫–∞ 8" },
            { id: 9, address: "—É–ª. –ö–∞–ª–º—ã–∫–æ–≤–∞, 79, –ù–∞–ª—å—á–∏–∫, –†–æ—Å—Å–∏—è", label: "—É–ª. –ö–∞–ª–º—ã–∫–æ–≤–∞, 79" },
            { id: 10, address: "—É–ª. –ù–∞–±–µ—Ä–µ–∂–Ω–∞—è, 22, –ù–∞–ª—å—á–∏–∫, –†–æ—Å—Å–∏—è", label: "—É–ª. –ù–∞–±–µ—Ä–µ–∂–Ω–∞—è, 22" },
            { id: 11, lat: 43.4735, lon: 43.6280, label: "–¢–æ—á–∫–∞ 11" }
        ];
        
        // Descriptions
        const DESCRIPTIONS = [
            { text: "–ö—Ä–∏—Ç–∏—á–Ω–æ. –ö—Ä—É–ø–Ω—ã–π –∑–∞–≤–∞–ª –ø–ª–∞—Å—Ç–∏–∫–∞ –∏ —à–∏–Ω —É –≤–æ–¥—ã", severity: "critical" },
            { text: "–¢—Ä–µ–±—É–µ—Ç —Å–ø–µ—Ü—Ç–µ—Ö–Ω–∏–∫–∏. –°—Ç–∏—Ö–∏–π–Ω–∞—è —Å–≤–∞–ª–∫–∞ —Å—Ç—Ä–æ–π–æ—Ç—Ö–æ–¥–æ–≤", severity: "urgent" },
            { text: "–°—Ä–µ–¥–Ω–µ. –ë—ã—Ç–æ–≤–æ–π –º—É—Å–æ—Ä –≤ –ª–µ—Å–æ–ø–æ–ª–æ—Å–µ", severity: "medium" },
            { text: "–°—Ä–æ—á–Ω–æ. –ó–∞—Ö–ª–∞–º–ª–µ–Ω–∏–µ —Å–∫–ª–æ–Ω–∞ –æ–≤—Ä–∞–≥–∞ –±—ã—Ç–æ–≤—ã–º –º—É—Å–æ—Ä–æ–º", severity: "urgent" },
            { text: "–ö—Ä–∏—Ç–∏—á–Ω–æ. –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ —Ä–∏—Ç—É–∞–ª—å–Ω—ã—Ö –æ—Ç—Ö–æ–¥–æ–≤ –∏ –ø–ª–∞—Å—Ç–∏–∫–∞", severity: "critical" },
            { text: "–°—Ä–æ—á–Ω–æ. –ú—É—Å–æ—Ä –Ω–∞ –±–µ—Ä–µ–≥–æ–≤–æ–π –ª–∏–Ω–∏–∏", severity: "urgent" },
            { text: "–ö—Ä–∏—Ç–∏—á–Ω–æ. –ú–∞—Å—à—Ç–∞–±–Ω–æ–µ –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –ø–æ–π–º—ã —Ä–µ–∫–∏ –ù–∞–ª—å—á–∏–∫", severity: "critical" },
            { text: "–¢—Ä–µ–±—É–µ—Ç —É–±–æ—Ä–∫–∏. –ú–µ—à–∫–∏ —Å –º—É—Å–æ—Ä–æ–º –≤–¥–æ–ª—å –¥–æ—Ä–æ–≥–∏", severity: "medium" },
            { text: "–°–ø–µ—Ü—Å–±–æ—Ä. –ü—Ä–∏–µ–º –±–∞—Ç–∞—Ä–µ–µ–∫ –∏ –ª–∞–º–ø", severity: "collection" },
            { text: "–°—Ä–æ—á–Ω–æ. –ó–∞–≥—Ä—è–∑–Ω–µ–Ω–∏–µ –∑–æ–Ω—ã –æ—Ç–¥—ã—Ö–∞", severity: "urgent" },
            { text: "–ö—Ä–∏—Ç–∏—á–Ω–æ. –°–±—Ä–æ—Å –º—É—Å–æ—Ä–∞ –≤ –æ–±—Ä—ã–≤", severity: "critical" }
        ];
        
        // Volnyy Aul boundary
        const VOLNYY_AUL_BOUNDARY = [
            [43.4900, 43.6000],
            [43.4900, 43.6600],
            [43.4500, 43.6600],
            [43.4500, 43.6000],
            [43.4900, 43.6000]
        ];
        
        // Severity colors
        const SEVERITY_COLORS = {
            critical: '#e74c3c',
            urgent: '#e67e22',
            medium: '#f39c12',
            collection: '#27ae60'
        };

        // ===============================================
        // GLOBAL VARIABLES
        // ===============================================
        
        let map;
        let routingControl = null;
        let geocodedLocations = [];
        let startPoint = null;
        let startMarker = null;
        let lastSelectedPollutionMarker = null;

        // ===============================================
        // UTILITY FUNCTIONS
        // ===============================================
        
        function updateStatus(message, className = '') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = className;
        }
        
        function updateLoadingText(main, sub = '') {
            document.getElementById('loadingSubtext').textContent = sub || main;
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function formatDistance(meters) {
            if (meters < 1000) return `${Math.round(meters)} –º`;
            return `${(meters / 1000).toFixed(2)} –∫–º`;
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            if (hours > 0) return `${hours} —á ${minutes} –º–∏–Ω`;
            return `${minutes} –º–∏–Ω`;
        }
        
        function getSeverityLabel(severity) {
            const labels = {
                critical: '–ö—Ä–∏—Ç–∏—á–Ω–æ',
                urgent: '–°—Ä–æ—á–Ω–æ',
                medium: '–°—Ä–µ–¥–Ω–µ',
                collection: '–ü—É–Ω–∫—Ç —Å–±–æ—Ä–∞'
            };
            return labels[severity] || severity;
        }

        // ===============================================
        // PANEL CONTROLS
        // ===============================================
        
        document.getElementById('closeBtn').addEventListener('click', function() {
            document.getElementById('ecoPanel').classList.add('hidden');
            document.getElementById('toggleBtn').classList.add('visible');
        });
        
        document.getElementById('toggleBtn').addEventListener('click', function() {
            document.getElementById('ecoPanel').classList.remove('hidden');
            document.getElementById('toggleBtn').classList.remove('visible');
        });

        // ===============================================
        // MAP INITIALIZATION
        // ===============================================
        
        function initMap() {
            updateLoadingText('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã', '–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑–æ–≤–æ–π –∫–∞—Ä—Ç—ã...');
            
            map = L.map('map', {
                center: CONFIG.mapCenter,
                zoom: CONFIG.defaultZoom,
                minZoom: CONFIG.minZoom,
                maxZoom: CONFIG.maxZoom
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Handle map clicks
            map.on('click', handleMapClick);
            
            updateStatus('–ö–∞—Ä—Ç–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'active');
        }

        // ===============================================
        // DISTRICT POLYGON
        // ===============================================
        
        function drawDistrictBoundary() {
            updateLoadingText('–û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–∞–π–æ–Ω–∞', '–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä–∞–Ω–∏—Ü –í–æ–ª—å–Ω–æ–≥–æ –∞—É–ª–∞...');
            
            const polygon = L.polygon(VOLNYY_AUL_BOUNDARY, {
                color: '#3498db',
                weight: 3,
                opacity: 0.8,
                fillColor: '#3498db',
                fillOpacity: 0.1,
                dashArray: '10, 5'
            }).addTo(map);
            
            const center = polygon.getBounds().getCenter();
            L.marker(center, {
                icon: L.divIcon({
                    className: 'district-label',
                    html: 'üìç –í–æ–ª—å–Ω—ã–π –∞—É–ª',
                    iconSize: [150, 35],
                    iconAnchor: [75, 17]
                }),
                interactive: false
            }).addTo(map);
        }

        // ===============================================
        // GEOCODING
        // ===============================================
        
        async function geocodeAddress(address) {
            const url = `${CONFIG.geocodingService}?format=json&q=${encodeURIComponent(address)}&limit=1&countrycodes=ru`;
            
            try {
                const response = await fetch(url, {
                    headers: { 'User-Agent': 'EcoMapNalchik/1.0' }
                });
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                
                if (data && data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lon: parseFloat(data[0].lon),
                        display_name: data[0].display_name
                    };
                }
                return null;
            } catch (error) {
                console.error(`Geocoding error:`, error);
                return null;
            }
        }
        
        async function processAllLocations() {
            updateLoadingText('–û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–∫–∞—Ü–∏–π', '–ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–æ–≤...');
            
            for (let i = 0; i < LOCATIONS.length; i++) {
                const loc = LOCATIONS[i];
                const description = DESCRIPTIONS[i];
                
                if (loc.lat && loc.lon) {
                    geocodedLocations.push({
                        id: loc.id,
                        lat: loc.lat,
                        lon: loc.lon,
                        label: loc.label,
                        description: description.text,
                        severity: description.severity,
                        source: 'coordinates'
                    });
                } else if (loc.address) {
                    updateLoadingText('–û–±—Ä–∞–±–æ—Ç–∫–∞ –ª–æ–∫–∞—Ü–∏–π', `–ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ ${i + 1}/${LOCATIONS.length}`);
                    
                    const result = await geocodeAddress(loc.address);
                    
                    if (result) {
                        geocodedLocations.push({
                            id: loc.id,
                            lat: result.lat,
                            lon: result.lon,
                            label: loc.label,
                            description: description.text,
                            severity: description.severity,
                            display_name: result.display_name,
                            source: 'geocoded'
                        });
                    } else {
                        const fallbackLat = CONFIG.mapCenter[0] + (Math.random() - 0.5) * 0.02;
                        const fallbackLon = CONFIG.mapCenter[1] + (Math.random() - 0.5) * 0.02;
                        
                        geocodedLocations.push({
                            id: loc.id,
                            lat: fallbackLat,
                            lon: fallbackLon,
                            label: loc.label,
                            description: description.text,
                            severity: description.severity,
                            source: 'fallback',
                            warning: '–ü—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã'
                        });
                    }
                    
                    await sleep(CONFIG.geocodingDelay);
                }
            }
            
            const criticalCount = geocodedLocations.filter(loc => loc.severity === 'critical').length;
            document.getElementById('criticalPoints').textContent = criticalCount;
        }

        // ===============================================
        // MARKERS
        // ===============================================
        
        function createMarkers() {
            updateLoadingText('–°–æ–∑–¥–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤', '–†–∞–∑–º–µ—â–µ–Ω–∏–µ —ç–∫–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–µ–∫...');
            
            geocodedLocations.forEach((loc) => {
                const markerColor = SEVERITY_COLORS[loc.severity];
                
                const markerIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `
                        <div style="
                            background-color: ${markerColor};
                            color: white;
                            border-radius: 50%;
                            width: 38px;
                            height: 38px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: bold;
                            font-size: 15px;
                            border: 3px solid white;
                            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
                            cursor: pointer;
                        ">${loc.id}</div>
                    `,
                    iconSize: [38, 38],
                    iconAnchor: [19, 19],
                    popupAnchor: [0, -25]
                });
                
                const marker = L.marker([loc.lat, loc.lon], { icon: markerIcon }).addTo(map);
                
                let popupContent = `
                    <div class="popup-header">–¢–æ—á–∫–∞ ${loc.id}: ${loc.label}</div>
                    
                    <div class="popup-section">
                        <div class="popup-label">–°—Ç–∞—Ç—É—Å</div>
                        <span class="severity-badge severity-${loc.severity}">
                            ${getSeverityLabel(loc.severity)}
                        </span>
                    </div>
                    
                    <div class="popup-section">
                        <div class="popup-label">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</div>
                        <div class="popup-description">${loc.description}</div>
                    </div>
                    
                    <div class="popup-section">
                        <div class="popup-label">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</div>
                        <div>${loc.lat.toFixed(5)}, ${loc.lon.toFixed(5)}</div>
                    </div>
                `;
                
                if (loc.display_name) {
                    popupContent += `
                        <div class="popup-section">
                            <div class="popup-label">–ê–¥—Ä–µ—Å</div>
                            <div>${loc.display_name.split(',').slice(0, 3).join(',')}</div>
                        </div>
                    `;
                }
                
                marker.bindPopup(popupContent);
                
                // Click handler
                marker.on('click', function() {
                    handlePollutionMarkerClick(loc);
                });
            });
        }

        // ===============================================
        // ROUTING LOGIC
        // ===============================================
        
        function handleMapClick(e) {
            // User clicked on map - set this as start point
            startPoint = e.latlng;
            
            // Remove old start marker if exists
            if (startMarker) {
                map.removeLayer(startMarker);
            }
            
            // Create new start marker
            const startIcon = L.divIcon({
                className: 'start-point-marker',
                html: `
                    <div style="
                        background-color: #3498db;
                        color: white;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 20px;
                        border: 3px solid white;
                        box-shadow: 0 4px 12px rgba(52, 152, 219, 0.6);
                    ">üìç</div>
                `,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
            
            startMarker = L.marker(startPoint, { icon: startIcon }).addTo(map);
            startMarker.bindPopup('<strong>–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –º–∞—Ä—à—Ä—É—Ç–∞</strong>').openPopup();
            
            updateStatus('–ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –≤—ã–±—Ä–∞–Ω–∞. –¢–µ–ø–µ—Ä—å –∫–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –º–∞—Ä–∫–µ—Ä –∑–∞–≥—Ä—è–∑–Ω–µ–Ω–∏—è.', 'waiting');
            
            // If we already had a pollution marker selected, rebuild route
            if (lastSelectedPollutionMarker) {
                buildRoute(lastSelectedPollutionMarker);
            }
        }
        
        function handlePollutionMarkerClick(location) {
            lastSelectedPollutionMarker = location;
            
            if (!startPoint) {
                updateStatus('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω—É—é —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ!', 'waiting');
                return;
            }
            
            buildRoute(location);
        }
        
        function buildRoute(targetLocation) {
            updateStatus(`–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∞ –∫ —Ç–æ—á–∫–µ ${targetLocation.id}...`, 'active');
            
            // Remove old routing control
            if (routingControl) {
                map.removeControl(routingControl);
            }
            
            const waypoints = [
                L.latLng(startPoint.lat, startPoint.lng),
                L.latLng(targetLocation.lat, targetLocation.lon)
            ];
            
            routingControl = L.Routing.control({
                waypoints: waypoints,
                router: L.Routing.osrmv1({
                    serviceUrl: CONFIG.routingService,
                    profile: 'driving'
                }),
                lineOptions: {
                    styles: [{ color: '#9b59b6', opacity: 0.8, weight: 6 }],
                    extendToWaypoints: true,
                    missingRouteTolerance: 10
                },
                show: false,
                addWaypoints: false,
                routeWhileDragging: false,
                draggableWaypoints: false,
                fitSelectedRoutes: true,
                showAlternatives: false,
                createMarker: function() { return null; }
            }).addTo(map);
            
            routingControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                
                document.getElementById('routeDistance').textContent = formatDistance(summary.totalDistance);
                document.getElementById('routeTime').textContent = formatTime(summary.totalTime);
                document.getElementById('routeTarget').textContent = targetLocation.label;
                document.getElementById('routeInfo').classList.add('active');
                
                updateStatus(`–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω: ${formatDistance(summary.totalDistance)}`, 'active');
            });
            
            routingControl.on('routingerror', function(e) {
                console.error('Routing error:', e);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞', 'waiting');
            });
        }

        // ===============================================
        // MAIN EXECUTION
        // ===============================================
        
        async function main() {
            try {
                console.log('=== Starting environmental map ===');
                
                initMap();
                await sleep(500);
                
                drawDistrictBoundary();
                await sleep(500);
                
                await processAllLocations();
                await sleep(500);
                
                createMarkers();
                await sleep(500);
                
                hideLoading();
                updateStatus('–ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–∞—Ä—Ç—É –¥–ª—è –≤—ã–±–æ—Ä–∞ –Ω–∞—á–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–∏ –º–∞—Ä—à—Ä—É—Ç–∞', 'waiting');
                
                console.log('=== Map ready ===');
                
            } catch (error) {
                console.error('Fatal error:', error);
                alert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç—ã:\n${error.message}`);
            }
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main);
        } else {
            main();
        }
        
    </script>
</body>
</html>
